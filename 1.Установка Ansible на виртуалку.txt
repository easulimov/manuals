Обновляем систему:
dnf update

Проверяем версию python3:
python3 --version

Обновить pip:
python3 -m pip install --upgrade pip

Обновить все пакеты:
#--no-cache-dir - добавить ключ, чтобы не использовать кэш
pip3 install -U $(pip3 freeze | cut -d '=' -f 1) 

Установка Ansible:
python3 -m pip install ansible

Проверка версии:
ansible --version

Создадим конфигурационный файл ansible.cfg:

vim ansible.cfg
######################################################################################
[defaults]

#указываем расположение файла inventory
inventory = /root/ansible/hosts  

#при подключении к клиентам не будет проверяться рукопожатие 
host_key_checking = false 

######################################################################################


Отредактируем файл inventory file /root/ansible/hosts:

vim /root/ansible/hosts
######################################################################################
[main]
client01 ansible_host=192.168.8.11 ansible_user=root ansible_password=123

[test]
client02 ansible_host=192.168.8.12 ansible_user=root ansible_ssh_private_key_file=/root/.ssh/id_rsa

[all_servers:children]
main
test

######################################################################################
***доступ по паролю не будет работать, без программы sshpass
dnf install sshpass

Проверим соединение с клиентами:
ansible all -m ping
ansible main -m ping
ansible test -m ping

Простые команды:

#Получить информацию о всех клиентах
ansible all -i hosts -m setup

#Выполнить shell команду на всех клиентах
ansible all -i hosts -m shell -a "uptime"

***shell запускается без проверки, например был создан ранее файл или нет, все равно будет записан новый/перезаписан.
Также имеются модули raw и command.
raw отличается от command и shell тем, что не выполняет дополнительную обработку выполнения команды. Эти дополнительные обработки присутствуют в почти любом модуле Ansible. Модуль raw передает команду, как есть в "сыром" виде без проверок.
Модули command и shell отличаются тем, что в модуле command команда выполняется без прохождения через оболочку /bin/sh. Поэтому переменные определенные в оболочке и перенаправления-конвееры работать не будут. Модуль shell выполняет команды через оболочку по умолчанию /bin/sh. Поэтому там будут доступны переменные оболочки и перенаправления.

#Создать файл на всех клиентах
ansible all -i hosts -m file -a "path=/root/ansible_test.txt state=touch"

#Скопировать файл на все клиенты группы test
ansible test -i hosts -m copy -a "src=/root/ansible_test.txt dest=/tmp mode=777" -b

*** -b - become
Ключевое слово become использует существующие инструменты повышения привилегий, такие как sudo, su, pfexec, doas, pbrun, dzdo, ksu, runas, machinectl и другие.

Получение привилегий sudo для учетной записи на удаленном хосте, для выполнения команд с ключем -b или параметром become: yes :
$ echo "$(whoami) ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$(whoami)


######################################################################################
#Создание роли:
mkdir roles
cd roles
ansible-galaxy init deploy_apache_web


Роль Ansible – это набор файлов, задач, шаблонов, переменных и обработчиков, которые вместе служат определенной цели, например, для настройки службы. Роли позволяют легко повторно использовать код и делиться решениями Ansible с другими пользователями, что делает работу с большими средами более управляемой.

Структура каталога ролей
Типичная роль Ansible следует определенной структуре каталогов, которая обычно состоит из следующих каталогов:

- defaults: содержит переменные по умолчанию для роли, которые должны быть легко перезаписаны.
- vars: содержит стандартные переменные для роли, которые не должны быть перезаписаны в вашей книге.
- tasks: содержит набор задач, которые должна выполнять роль.
- handlers: содержит набор обработчиков, которые будут использоваться в роли.
- templates: содержит шаблоны Jinja2, которые будут использоваться в роли.
- files: содержит статические файлы, необходимые из ролевых задач.
- tests: может содержать дополнительный файл инвентаря, а также playbook test.yml, который можно использовать для тестирования роли.
- meta: содержит метаданные роли, такие как информация об авторе, лицензия, зависимости и т. д.
Имейте в виду, что у роли могут быть все вышеупомянутые каталоги или только их часть. Фактически, вы можете определить пустую роль, у которой нет каталогов, но это бесполезно!

Хранение и расположение ролей
По умолчанию Ansible будет искать роли в двух местах:

- В каталоге role (тот же уровень каталога, что и ваш файл playbook).
- В каталоге /etc/ansible/roles.
Однако вы можете сохранить свои роли в другом месте; если вы решите это сделать, вы должны указать и установить параметр конфигурации roles_path в файле конфигурации Ansible ( ansible.cfg ).


######################################################################################







